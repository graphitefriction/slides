[[when-websocket-met-asciidoctor]]
[.topic]
= Real-time *collaborative* *editor* for *AsciiDoc* &#160;&#160;&#160; _When WebSocket met Asciidoctor_
Maxime GREAU <http://mgreau.com[@mgreau]>
v1.0, March 24, 2014
:hashtag:  #Asciidoctor #WebSocket #JavaEE7
:copyright: CC BY-SA 2.0
:website: http://asciidoctor.org
:dzslides-aspect: 16-9
:icons: font
:dzslides-style: devnation
:dzslides-fonts: family=Open+Sans:400,700,200,300
:dzslides-transition: fade
:dzslides-highlight: asciidoctor
:language: highlight
:source-highlighter: highlightjs
:snippets: https://raw.github.com/mgreau/slides/master/websocket-asciidoctor/devnation/snippets
:images_dir: https://raw.github.com/mgreau/slides/master/websocket-asciidoctor/devnation/images


[[slide2]]
[.topic]
== Me

[.incremental]
* IT Architect [detail]#Ministry for the Economy and Finance#
* Author [detail]#Apache Maven (French Book)#
* Technical Reviewer [detail]#WildFly - EE7#
* Blog [detail]#http://mgreau.com#
* Twitter [detail]#@mgreau# #adeditor

[NOTE.speaker]
====
----
SLIDE 1 : Introduction
----

Hi, Thanks for coming, it's a honor for me to be here. So thanks to the DevNation team.
My name is Maxime Gréau. As you can hear, I'm a French guy and I will do my best to be well understood despite my accent.

So I'm here to speak mainly about Java EE 7, WebSocket and Asciidoctor and others technologies.
And I will show you how all those technologies can fit together in order to do a Real-time Collaborative Editor for AsciiDoc

----
SLIDE 2 : Overview
----
Just a quick overview about me.
So I work for the French Ministry for the Economy and Finance in France.
More precisely in the department which is in charge of calculate the retirement pension for the state officials
http://www.economie.gouv.fr/welcome-to-the-french-ministry-for-the-economy-and-finance

* I'm also a Book Author since I wrote a French book about Apache Maven 3 years ago.
* I'm currently reviewing a book about WidFly and Java EE 7
* If you want to know more about me, you can check my website or follow me on twitter.
* Near my twitter account, you can see the hastag #adeditor which is the hashtag that I used just before this session
in order to post 2 URLs for demonstration. 
So you can search for this hastag on twitter and you will be ready for the the demo.

====

[[slide3]]
[.topic]
== When _WebSocket_ met *Asciidoctor*

       .o.                           o8o   o8o  oooooooooo.                       
      .888.                          `"'   `"'  `888'   `Y8b                      
     .8"888.      .oooo.o  .ooooo.  oooo  oooo   888      888  .ooooo.   .ooooo.  
    .8' `888.    d88(  "8 d88' `"Y8 `888  `888   888      888 d88' `88b d88' `"Y8 
   .88ooo8888.   `"Y88b.  888        888   888   888      888 888   888 888       
  .8'     `888.  o.  )88b 888   .o8  888   888   888     d88' 888   888 888   .o8 
 o88o     o8888o 8""888P' `Y8bod8P' o888o o888o o888bood8P'   `Y8bod8P' `Y8bod8P'


[NOTE.speaker]
====
----
SLIDE 3 : Bench of technologies
----
* Here you can see all the technologies that this project is about : AsciiDoc, Asciidoctor, WebSocket Java EE 7,
but also HTML5, Javascript and Angular. And this application is deployed to the Cloud on WildFly 8 with OpenShift.
====

[[slide4]]
[.topic.recap]
== Quick Polls

[.statement]
* Who _sent an email today_?

[NOTE.speaker]
====
----
SLIDE 4 : Poll
----
* OK so a quick poll, it's 5pm, who sent an email today ? hands up please. OK
====

[[slide5]]
[.topic.recap]
== Quick Polls

[.statement]
* Who _wrote technical documentation_ in the past two days ?

[NOTE.speaker]
====
----
SLIDE 5 : Poll
----
* Next, who wrote technical documentation in the past two days ? you put your hands up too, 
Yeah, that's what I thougt, there is far fewer people.
====


[[slide6]]
[.topic.intro]
== ``Writing documentation has to be _as easy as_ writing email !''


[NOTE.speaker]
====
----
SLIDE 6 : Easy
----
* HERE WE ARE !
* Writing e-mail is easy. We do it all the time. Every day, we respond to dozens of e-mail
and social media messages with Twitter, facebook.... That involves communication through writing. 
That’s right, writing!
* So Writing documentation has to be as easy as writing email !
* So how can we write documentation on an easy way ?

. References
http://asciidoctor.org/docs/what-is-asciidoc/
====

[[slide7]]
[.intro.topic]
== *AsciiDoc* to the rescue

[NOTE.speaker]
====
----
SLIDE 7 : AsciiDoc
----
* The idea behind lightweight markup languages such as AsciiDoc is "Forget about the layout and styling and just let the thoughts flow"  
* AsciiDoc is being around for a while. It was created twelve years ago and based on Python.

. References
http://asciidoctor.org/docs/what-is-asciidoc/
====

[[slide8]]
[.topic]
== &#160;

[.statement]
AsciiDoc is... +
lightweight *markup* +
[.push2]#publishing *toolchain*#

[NOTE.speaker]
====
----
SLIDE 8 : AsciiDoc
----
* So What is AsciiDoc ?
AsciiDoc is two things:

** A mature[1], plain-text format for authoring notes, articles, documentation, 
books, ebooks, web pages, slide decks, blog posts, man pages and more.
** A text processor and toolchain for translating AsciiDoc documents into various formats (called backends), 
including HTML, DocBook, PDF and ePub[2].

AsciiDoc provide a plain text syntax designed for humans--easy to edit, read, version and share in raw form. AsciiDoc goes further by satisfying even the most advanced technical semantics and publishing requirements. AsciiDoc is a capable shorthand alternative to DocBook and can produce beautiful HTML 5, ePub and PDF output--even slides! Follow the lead of authors

. References
http://asciidoctor.org/docs/what-is-asciidoc/
====

[[slide9]]
[.topic.source]
== AsciiDoc : *Lightweight markup*

[source, asciidoc]
----
= Document Title2
Doc Writer <doc@asciidoc.org>
v1.0, 2013-01-01: Initial version

http://asciidoc.org[AsciiDoc] is a lightweight markup language.

This is the optional preamble (an untitled section body), useful for
writing simple sectionless documents consisting only of a preamble.

NOTE: The abstract, preface, appendix, bibliography, glossary and
index section titles are significant (_specialsections_).

== First section

Document sections start at *level 1* and can nest four levels deep.

* Item 1
* Item 2
----

[NOTE]
[role="speaker"]
====
----
SLIDE 9 : example
----
* so here is an example.
* this is just plain text
* you see a couple of annotations
* the first thing is just the title	
* then we have a paragraph 
* then we have an other section 
* AsciiDoc gets us back to what’s important: writing. 

You can drop those angle brackets, but you don’t have to drop the semantics. 
And it’s a syntax that a human can actually edit, efficiently.

====


[[slide10]]
[.topic]
== &#160;

"Use _AsciiDoc_ for document markup. It's actually _readable_ by humans, _easier to parse_ way more flexible than XML."
-- Linus Torvald

[NOTE.speaker]
====
----
SLIDE 10 : Linus Torvald
----
* Why do you need to use AsciiDoc for documentation... because Linus Torvald said it.
More seriously, AsciiDoc works because:

** It’s readable
** It’s concise
** It’s comprehensive
** It’s extensible
** It produces beautiful output (HTML, DocBook, PDF, ePub and more)

* Regarding to the other office tools, AsciiDoc gives you the possibility to
follow almost the same workflow that you have when writing code :
** refactor the documentation
** do a simple diff on documentation
So It looks like code, it hacks like code, it can be check on the source code revising control just like code

====

[[slide11]]
[.intro.topic]
== What's *Asciidoctor* ?

[NOTE.speaker]
====
----
SLIDE 11 : Asciidoctor
----
* Remember that I said that AsciiDoc is not really that new. 
It's Python based but there is a bright new tools out there since 2013, which is ruby based.
There are ways to run this things inside the JVM and this is Asciidoctor.
====

[[slide11]]
[.topic]
== &#160;

[.statement]
*Asciidoctor* +
A modern, open source implementation of AsciiDoc in [.ruby]#Ruby#

[NOTE.speaker]
====
----
SLIDE 11 : Asciidoctor
----
* Asciidoctor is a modern open-source implementation of AsciiDoc, written in Ruby mainly by Dan Allen and the community
* The idea is : 
** we have a asciidoc document
** we have an asciidoc processor
** we put the document to the processor
** and VOILA => it comes to HTML
====


[[slide12]]
[.topic]
== Output *formats* (i.e., backends)

[.incremental]
* HTML 5
* DocBook 4.5 & 5.0
* PDF [detail]#fop, dblatex#
* eBook [detail]#ePub 2, mobi#
* slides [detail]#deck.js, dzslides, reveal.js#
* man pages
* *custom*

[NOTE.speaker]
====
----
SLIDE 12 : Output
----
* So what can Asciidoctor make ?
* Asciidoctor can do HTML5, DocBook, PDF, ePub, mobi
* Asciidoctor can do slides like this deck, can do man pages
* and most important "anything you want"
** you have the ability to plug in your own backend so the HTML that you get, is not the HTML that you have to have 
**  Asciidocotor built a document Abstract Syntax Tree (AST), not to different to our source code (when we have classes and methods) 
so you have the ability to manipulate the document and you can create whatever you want
====

[[slide13]]
[.topic]
== How do I *use* Asciidoctor ?

[.incremental]
* Ruby [detail]#asciidoctor asciidoctor-pdf#
* Java [detail]#asciidoctorJ, asciidoctor-maven-plugin#
* Groovy [detail]#asciidoctor-gradle-plugin#
* Javascript [detail]#asciidoctor.js, Chrome/Firefox extension#

[NOTE.speaker]
====
----
SLIDE 13 : Polyglot
----
* The main project is asciidoctor, implemented in Ruby. asciidoctor-pdf is a native PDF renderer for AsciiDoc built with asciidoctor and prawn. AsciiDoc direct to PDF.
* So, ok it's Ruby,  but Ruby runs on the JVM thanks to JRuby !!
** There is an other project called AsciidoctorJ which is a wrapper on top of plain asciidoctor using JRUby
so you do not need Ruby to run Asciidoctor, you just need Java
** And from there we can construct any other tools based on the JVM that consumes asciidoctorJ and in this case we have a maven plugin and a gradle plugin
* You can also run Asciidoctor throught Javascript, Ruby has a transpiler call Opal. Opal transforms Ruby code into Javascript code so you can run Asciidoctor on the browser or anywhere that Javascript can be run.
** There are also a Chrome extension and a Firefox addon
* So we have a POLYGLOT environment here
====


[[slide14]]
[.topic]
== *Who* is using Asciidoctor ?

[.pull-right]
* Frameworks [detail]#Spring, Infinispan#
* JSR [detail]#CDI Specifications#
* Publishers [detail]#O'Reilly#
* Repositories [detail]#Github, Bintray#
* and more...

[NOTE.speaker]
====
----
SLIDE 14 : Who use it
----
* So Asciidoctor is a really new project but it's already much used, in fact we have
** some frameworks which generates their technical documentation with Asciidoctor like Spring, Infinispan and others
** There are already 2 JSR which used Asciidoctor : CDI and Bean Validation
** there are also some publisher like O'Reilly (enterprise Web Book)
** some repositories like Github, in fact you can write your doc file like README with AsciiDoc and you will see the rendered HTML
====


[[slide15]]
[.topic.recap]
== Demo time 1/3

Asciidoctor via asciidoctor.js

image::https://raw.github.com/mgreau/when-websocket-met-asciidoctor/master/doc/img/ad-editor-offline.png[Offline mode feature, 530, link="{imagesdir}ad-editor-offline.png"]

[NOTE.speaker]
====
----
SLIDE 15 : asciidoctor.js
----
DEMO :
. Present the ad-editor
.. on the left side, you have the AsciiDoc editor based on angular-ui-ace-editor
.. on the top of the screen, you have the navbar which tells you if you are working online or offline
.. in this case we are on offline mode since we just want to use Asciidoctor through asciidoctor.js, so we don't need the server to be started.
.. on the right side, we have the HTML5 rendered view, so here is the HTML5 generated by Opal.js and asciidoctor.js
. so let's goto the demo
.. do a drag and drop (HTML5) with the demo1.adoc
.. render it with Alt+R
.. change mode to "on change"
.. add text and add title => show the TOC and click to the last title
.. copy/paste source code to show higlight
.. save the doc (HTML5)
.. delete the content and re-load it to show HTML5 indexedDB

CONCLUDE:
* Ok that was the demo in order to show how Asciidoctor works with asciidoctor.js and some HTML5 features like drag and drop and storage with IndexedDB.

====

[[slide16]]
[.topic]
== Asciidoctor *resources*

* Website [detail]#http://asciidoctor.org (blog, user manual, writing guide...)#
* Github sources [detail]#http://github.com/asciidoctor#
* Forum [detail]#http://discuss.asciidoctor.org#
* Twitter [detail]#@asciidoctor @mojavelinux @alexsotob @lightguardjp#

[NOTE.speaker]
====
----
SLIDE 18 : Who use it
----
TODO: add book enterprise Web Book
====

[[slide19]]
[.intro.topic]
== Java EE 7  *WebSocket*

[NOTE.speaker]
====
----
SLIDE 19 : Second part
----
* OK so that was the part about documentation, AsciiDoc and Asciidoctor.
* We also had an introduction to the asciidoc editor application on offline mode.
* Now, let's talk about Java EE 7 and WebSocket.
====

[[slide20]]
[.topic]
== Java EE 7 - *Overview*

image::https://raw.githubusercontent.com/mgreau/slides/master/websocket-asciidoctor/images/javaee_overview.png[JavaEE7, 610]

[[slide21]]
[.topic]
== HTTP

* half-duplex
* verbose
* hack for push

[[slide22]]
[.topic]
== &#160;

"WebSocket is a _full-duplex_ _bi-directional_ protocol, over a _Single TCP Connection_."
-- Arun Gupta (RedHat)

[[slide23]]
[.topic]
== WebSocket

* 1 Protocol - RF6455
* 1 Java API - JSR 356
* 1 Javascrpt API - W3C

[[slide24]]
[.topic]
== WebSocket lifecycle schema

image::https://raw.githubusercontent.com/mgreau/slides/master/websocket-asciidoctor/images/websocket_protocol.png[lifecycle, 330]


[[slide25]]
[.topic.source]
== WebSocket - Handshake 

Request
[source, text]
----
GET /usopen/matches/1234 HTTP/1.1     # <1>
Host: wildfly-mgreau.rhcloud.com:8000  # <2>    
Upgrade: websocket  # <3>
Connection: Upgrade # <4>
Origin: http://wildfly-mgreau.rhcloud.com
Sec-WebSocket-Key:0EK7XmpTZL341oOh7x1cDw==
Sec-WebSocket-Version:13
----

*Response*
[source, text]
----
HTTP/1.1 101 Switching Protocols 
Connection:Upgrade
Sec-WebSocket-Accept:SuQ5/hh0kStSr6oIzDG6gRfTx2I=
Upgrade:websocket 
----

[[slide26]]
[.topic.source]
== Javascript API

[source,javascript]
----
var wsUri = "ws://echo.websocket.org/";
function testWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function(evt) { onOpen(evt) };
        websocket.onclose = function(evt) { onClose(evt) };
        websocket.onmessage = function(evt) { onMessage(evt) };
        websocket.onerror = function(evt) { onError(evt) }; }
}
function onOpen(evt) {
        writeToScreen("CONNECTED");
        doSend("WebSocket rocks");
}
function onClose(evt) {
        writeToScreen("DISCONNECTED");
}
function onMessage(evt) {
        writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
        websocket.close();
}
----



[[slide27]]
[.topic]
== Java API - JSR356

[.incremental]
* API for WebSocket Server and Client Endpoint
** Annotated: [detail]#`@ServerEndpoint`, `@ClientEndpoint`#
** Programmatic: [detail]#`Endpoint`#
** WebSocket opening handshake negotiation
* LIfecycle callback methods


[[slide28]]
[.topic.source]
== Java API - JSR356 - *@ServerEndpoint*

[source,java]
.+EchoServer.java+
----
import javax.websocket.OnMessage;
import javax.websocket.ServerEndpoint;

@ServerEndpoint("/echo") 
public class EchoServer {

        @OnMessage 
        public String handleMessage(String message){
                return "Thanks for the message: " + message;
        }
}

----

[[slide23]]
[.topic]
== Java API - JSR356 - Annotations

[cols="3"] 
|===
|@ServerEndpoint
|POJO to Server Endpoint
|
|@ClientEndpoint
|POJO to Client Endpoint
|
|@OnOpen
|Open connection
|
|@OnMessage
|Close connection
|
|===

[[slide26]]
[.intro.topic]
== *ad-editor* &#10; Demo & Code



[[slide27]]
[.topic]
== How does this project born ?

* Back to Devoxx 2013


[NOTE]
[role="speaker"]
====
* TODO : add twitter image
* Back to Devoxx 2013, on the agenda you had
** on one side you have a talk about Asciidoctor by Dan Allen : a powerful tools to write documentation 
** on the other side you have a talk about Java EE7 and WebSocket by Arun Gupta  a powerful technology to do real-time collaborative application
* So I had this idea : What about a cross-over between this 2 technologies => When WebSocket met Asciidoctor
====

[[slide29]]
[.topic.recap]
== Demo time 2/3

ad-editor : Asciidoctor via asciidoctorJ and WebSocket

http://goo.gl/RBhvtP or on twitter #

image::https://raw.github.com/mgreau/when-websocket-met-asciidoctor/master/doc/demo/collaborative-editor.gif[Collaborative-editor, 600, link="{demo-url}collaborative-editor.gif"]


[[slide30]]
[.topic.source]
== ad-editor : *JSR 356*

[source,java]
.+WWSMADEndpoint.java+
----
@ServerEndpoint(value = "/adoc/{adoc-id}", 
    decoders = { MessageDecoder.class }, 
	encoders = { AsciidocMessageEncoder.class, OutputMessageEncoder.class, NotificationMessageEncoder.class })
public class WWSMADEndpoint {
	
	static Set<Session> peers = Collections
			.synchronizedSet(new HashSet<Session>());

	@Inject @Backend("html5")
	Event<AsciidocMessageEvent> html5Event;
	
	@Inject @Backend("dzslides")
	Event<AsciidocMessageEvent> dzEvent;
	
	@OnMessage
	public void message(final Session session, AsciidocMessage msg,
			@PathParam("adoc-id") String adocId) {
	}
}	
----

[NOTE.speaker]
====
TODO : add schema
====

[[slide31]]
[.topic.source]
== ad-editor : *CDI*

[source,java]
.+AsciidocMessageConsumer.java+
----
public class AsciidocMessageConsumer {
	
	@Inject
	AsciidoctorProcessor processor;

	public void html5RenderedEvent(@Observes @Backend("html5") AsciidocMessageEvent event){
	}
	
	public void dzslidesRenderedEvent(@Observes @Backend("dzslides") AsciidocMessageEvent event){
	    ...
	}
}	
----


[[slide32]]
[.topic.source]
== ad-editor : *Javascript*

[source,java]
.+services.js+
----
// Send an adoc source to see the generated output back
service.sendAdocSource = function(idAdoc, source, writer, backend) {
		var jsonObj = {"type" : backend, "source" : source, "writer": writer};
		service.ws[idAdoc].send(JSON.stringify(jsonObj));
	};
	
// Send 2 adoc source to see the diff
service.sendAdocSourceForDiff = function(idAdoc, source, writer, sourceToMerge) {
		var jsonObj = {"type" : "adoc-for-diff", "source" : source, "writer": writer, "sourceToMerge" : sourceToMerge};
		service.ws[idAdoc].send(JSON.stringify(jsonObj));
	};
----	

[[slide36]]
[.topic]
== What's next for ad-editor ?

* Github worflow
* PDF renderer
* OAuth
* Chat (audio, text)
* pull request are welcome :)

[NOTE.speaker]
====
----
SLIDE 36 : What's next
----
* What's next for this project ?
 a lot of new features will happen, feedbacks are welcome
====

[[slide33]]
[.intro.topic]
== DevNation *Killer feature* ?

[NOTE.speaker]
====
----
SLIDE 27 : Killer feature
----
* Ok so I pretty sure that you already love Asciidoctor, WebSocket and so ad-editor, am I right ?
So do you want a killer feature ? OK let's go...
====

[[slide34]]
[.topic]
== Asciidoctor *AST* Transformation

[.incremental]
* Asciidoctor propose an *AST feature*...
* So easy to render *one part* of the document...
*  and we can render *HTML5 slides*...
* and we have the *WebSocket protocol*...

[NOTE.speaker]
====
----
SLIDE 28 : AST
----
* Remember that I said that Asciidoctor provide an AST (Abstract syntax tree) feature. So that means that you can do a lot of things with the document
like render only a selected part of it. Plus Asciidoctor can render slides, Plus WebSocket which provide a full-duplex bi-directional protocol...
====


[[slide35]]
[.topic.recap]
== Demo-time 3/3

[.statement]
*Start your engine*

http://goo.gl/gWVz4I
SpaceID : 85

[NOTE.speaker]
====
----
SLIDE 28 : AST
----
* So prepare your smartphone : iphone, android, whatever
* prepare your laptotp, your ipad
* open this URL and connect with your name and the ID 85 and just wait
* code asciidoctor for daft punk
video::-SfXIRHbHKU[youtube, 640, 360, start=60, options=autoplay]
====



[[slide37]]
[.topic]
== Thanks to...

[.middle]
* &#160; [detail]#@alexsotob#
* &#160; &#160; [detail]#@mojavelinux# and the Asciidoctor community
* &#160; [detail]#@arungupta#
* &#160; &#160; [detail]#@tgrall#

[NOTE.speaker]
====
----
SLIDE 37 : Thanks to
----
* Quickly thanks to alex, dan and the asciidoctor community and to arun and tug
====

[[slide38]]
[.ending]
== Thank you

http://github.com/mgreau/when-websocket-met-asciidoctor[when-websocket-met-asciidoctor on Github]

[role="footer"]
Maxime Gréau - Thanks

[NOTE.speaker]
====
----
SLIDE 38 : Thank YOU
----
* Thank you. I hope that this session 
* We have a couple of minutes, is there any questions ?

* Questions :
** security => like servlet protocol + wss
** scalability => based on TCP connection so on open file limit on linux (1 Million)
====



